# SQL commands to extract various properties about entities
contracts: "
SELECT entities.eid AS eid, SUM(contracts.total) AS total 
FROM entities 
LEFT JOIN contracts ON entities.id = contracts.id 
WHERE contracts.total > 0
GROUP BY entities.id
"

is_politician: "
SELECT entities.eid AS eid,
       ((funkcionar = 'ano') OR
        (entities.ds_sponzori_stran is not null) OR
        (entities.ds_stranicke_prispevky is not null)) AS is_politician
FROM entities
LEFT JOIN uzivatelia_vyhody_ludia_data ON
          entities.id = uzivatelia_vyhody_ludia_data.id
"

is_zrsr: "
SELECT eid, ((zrsr is not null)) AS is_zrsr
FROM entities
"

is_orsr: "
SELECT eid, ((new_orsr is not null)) AS is_orsr
FROM entities
"

# Commands used to populate contracts sql table
otvorene_zmluvy_contracts: "
INSERT INTO contracts (id, total, customer, source, confidence)
SELECT DISTINCT entities.id, ds_otvorenezmluvy.total_amount, ds_otvorenezmluvy.customer, ds_otvorenezmluvy.source_url, 1.0
FROM entities
JOIN new_orsr_data ON entities.id = new_orsr_data.id
JOIN ds_otvorenezmluvy ON ds_otvorenezmluvy.supplier_ico = new_orsr_data.ico
WHERE new_orsr_data.ico > 0
"

# TODO: proper escaping
# TODO: instead of having everything in one table, have separate tables for different sources
procurements_contracts: "
INSERT INTO contracts (id, total, customer, source, confidence)
SELECT DISTINCT entities.id, 
                IF(ds_procurements.currency='Sk', ds_procurements.price / 30.126,
                                                  ds_procurements.price), 
                CONCAT('O: ', ds_procurements.customer_name),
                CONCAT('https://www.google.com/search?q=',
                        CONCAT(ds_procurements.procurement_id,' site:uvo.gov.sk')),
                1.0
FROM entities
JOIN new_orsr_data ON entities.id = new_orsr_data.id
JOIN ds_procurements ON ds_procurements.supplier_ico = new_orsr_data.ico
WHERE new_orsr_data.ico > 0;
"

# Commands used to compute entity name suffixes
entity_name_suffixes_table: "DELETE from entity_name_suffixes"
#DROP TABLE IF EXISTS entity_name_suffixes;
#CREATE TABLE entity_name_suffixes (
#        eid INT,
#        suffix VARCHAR(255)
#) DEFAULT charset=utf8
#"

entity_name_suffixes_index: "
CREATE INDEX entity_name_index ON entity_name_suffixes(suffix);
"
